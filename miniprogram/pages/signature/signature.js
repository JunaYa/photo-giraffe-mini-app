"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const bezier_1 = require("../../lib/bezier");
const point_1 = require("../../lib/point");
const throttle_1 = require("../../lib/throttle");
let ctx = null;
let isTouching = false;
let _isEmpty = false;
let minDistance = 5;
let backgroundColor = '#4f736d';
let pen = { color: '#333333', width: 1, _maxWidth: 10 };
let dpr = 1;
let _maxWidth = 2.5;
let _minWidth = 0.5;
let _dotSize = (_minWidth + _maxWidth) / 2;
let _lastPoints = [];
let velocityFilterWeight = 0.7;
let _lastVelocity = 0;
let _lastWidth = (_minWidth + _maxWidth) / 2;
let _strokeMoveUpdate = null;
let timeLine = [];
Page({
    data: {},
    onLoad: function (options) {
        console.log('onLoad', options);
    },
    onReady: function () {
        this.initContext();
        _strokeMoveUpdate = throttle_1.throttle(this._strokeUpdate, 16);
    },
    onShow: function () {
    },
    onHide: function () {
    },
    onUnload: function () {
    },
    initContext() {
        const { pixelRatio, windowWidth, windowHeight } = wx.getSystemInfoSync();
        dpr = pixelRatio;
        console.log('pixelRatio', pixelRatio);
        const query = wx.createSelectorQuery();
        query.select('#canvas').node().exec((res) => {
            const canvas = res[0].node;
            console.log('canvas --- ', canvas);
            canvas.width = windowWidth;
            canvas.height = windowHeight;
            ctx = canvas.getContext('2d');
            console.log('ctx', ctx);
            ctx.fillStyle = backgroundColor;
            ctx.fillRect(16, 16, ctx.canvas.width - 32, ctx.canvas.height - 32);
        });
    },
    onTouchStart(event) {
        console.log('touch start -- ', event);
        isTouching = true;
        this._strokeBegin(event);
    },
    onTouchMove(event) {
        _strokeMoveUpdate(event);
    },
    onTouchEnd(event) {
        console.log('touch end --', event);
        isTouching = false;
        this._strokeEnd(event);
    },
    onTouchCancel(event) {
        console.log('touch cancel', event);
        isTouching = false;
        this._strokeEnd(event);
    },
    onError(event) {
        console.log('canvas error', event);
        isTouching = false;
        this._strokeEnd(event);
    },
    _strokeBegin(event) {
        console.log('_strokeBegin ++++++++');
        const newPointGroup = {
            color: pen.color,
            points: [],
        };
        timeLine.push(newPointGroup);
        this._reset();
        _strokeMoveUpdate(event);
    },
    _strokeUpdate(event) {
        if (timeLine.length === 0) {
            this._strokeBegin(event);
            return;
        }
        const { x, y } = event.changedTouches[0];
        const point = this._createPoint(x, y);
        const lastPointGroup = timeLine[timeLine.length - 1];
        const lastPoints = lastPointGroup.points;
        const lastPoint = lastPoints.length > 0 && lastPoints[lastPoints.length - 1];
        const isLastPointTooClose = lastPoint ? point.distanceTo(lastPoint) <= minDistance : false;
        pen.color = lastPointGroup.color;
        if (!lastPoint || !(lastPoint && isLastPointTooClose)) {
            const curve = this._addPoint(point);
            if (!lastPoints) {
                this._drawDot(point);
            }
            else if (curve) {
                this._drawCurve(curve);
            }
        }
    },
    _strokeEnd(event) {
        console.log('end +++++++ ', event);
        _strokeMoveUpdate(event);
    },
    _calculateCurveWidths(startPoint, endPoint) {
        const velocity = velocityFilterWeight * endPoint.velocityFrom(startPoint) + (1 - velocityFilterWeight) * _lastVelocity;
        const newWidth = this._strokeWidth(velocity);
        const widths = {
            start: _lastWidth,
            end: newWidth,
        };
        _lastVelocity = velocity;
        _lastWidth = newWidth;
        return widths;
    },
    _strokeWidth(velocity) {
        return Math.max(_maxWidth / (velocity + 1), _minWidth);
    },
    _createPoint(x, y) {
        const left = 0;
        const top = 0;
        return new point_1.Point(x - left, y - top, new Date().getTime());
    },
    _addPoint(point) {
        if (timeLine.length > 1) {
            console.log('---------- timeLine ------');
            timeLine[timeLine.length - 1].points.push(point);
        }
        _lastPoints.push(point);
        if (_lastPoints.length > 2) {
            if (_lastPoints.length === 3) {
                _lastPoints.unshift(_lastPoints[0]);
            }
            const widths = this._calculateCurveWidths(_lastPoints[1], _lastPoints[2]);
            const curve = bezier_1.Bezier.fromPoints(_lastPoints, widths);
            _lastPoints.shift();
            return curve;
        }
        return null;
    },
    _drawDot(point) {
        ctx.beginPath();
        const width = _dotSize;
        this._drawCurveSegment(point.x, point.y, width);
        ctx.closePath();
        ctx.fillStyle = pen.color;
        ctx.fill();
    },
    _drawCurveSegment(x, y, width) {
        ctx.moveTo(x, y);
        ctx.arc(x, y, width, 0, 2 * Math.PI, false);
        _isEmpty = false;
    },
    _drawCurve(curve) {
        console.log('_drawCurve ---- ', curve);
        const widthDelta = curve.endWidth - curve.startWidth;
        const drawSteps = Math.floor(curve.length()) * 2;
        ctx.beginPath();
        ctx.fillStyle = pen.color;
        for (let i = 0; i < drawSteps; i += 1) {
            const t = i / drawSteps;
            const tt = t * t;
            const ttt = tt * t;
            const u = 1 - t;
            const uu = u * u;
            const uuu = uu * u;
            let x = uuu * curve.startPoint.x;
            x += 3 * uu * t * curve.control1.x;
            x += 3 * u * tt * curve.control2.x;
            x += ttt * curve.endPoint.x;
            let y = uuu * curve.startPoint.y;
            y += 3 * uu * t * curve.control1.y;
            y += 3 * u * tt * curve.control2.y;
            y += ttt * curve.endPoint.y;
            const width = Math.min(curve.startWidth + ttt * widthDelta, pen._maxWidth);
            this._drawCurveSegment(x, y, width);
        }
        ctx.closePath();
        ctx.fill();
    },
    _lineTo(x, y) {
        ctx.lineTo(x * dpr, y * dpr);
    },
    _moveTo(x, y) {
        ctx.moveTo(x * dpr, y * dpr);
    },
    _reset() {
        _lastPoints = [];
        _lastVelocity = 0;
        _lastWidth = (_minWidth + _maxWidth) / 2;
        ctx.fillStyle = pen.color;
    },
    _clear() {
        ctx.fillStyle = backgroundColor;
        ctx.clearRect(16, 16, ctx.canvas.width - 32, ctx.canvas.height - 32);
        ctx.fillRect(16, 16, ctx.canvas.width - 32, ctx.canvas.height - 32);
        timeLine = [];
        this._reset();
        _isEmpty = true;
        console.log(_isEmpty);
        console.log(isTouching);
    },
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2lnbmF0dXJlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsic2lnbmF0dXJlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQ0EsNkNBQXlDO0FBQ3pDLDJDQUFtRDtBQUNuRCxpREFBNkM7QUFTN0MsSUFBSSxHQUFHLEdBQVEsSUFBSSxDQUFBO0FBRW5CLElBQUksVUFBVSxHQUFZLEtBQUssQ0FBQTtBQUMvQixJQUFJLFFBQVEsR0FBWSxLQUFLLENBQUE7QUFDN0IsSUFBSSxXQUFXLEdBQVcsQ0FBQyxDQUFBO0FBQzNCLElBQUksZUFBZSxHQUFHLFNBQVMsQ0FBQTtBQUMvQixJQUFJLEdBQUcsR0FBRyxFQUFFLEtBQUssRUFBRSxTQUFTLEVBQUUsS0FBSyxFQUFFLENBQUMsRUFBRSxTQUFTLEVBQUUsRUFBRSxFQUFFLENBQUE7QUFDdkQsSUFBSSxHQUFHLEdBQUcsQ0FBQyxDQUFBO0FBRVgsSUFBSSxTQUFTLEdBQVcsR0FBRyxDQUFBO0FBQzNCLElBQUksU0FBUyxHQUFXLEdBQUcsQ0FBQTtBQUMzQixJQUFJLFFBQVEsR0FBVyxDQUFDLFNBQVMsR0FBRyxTQUFTLENBQUMsR0FBRyxDQUFDLENBQUE7QUFFbEQsSUFBSSxXQUFXLEdBQVksRUFBRSxDQUFBO0FBQzdCLElBQUksb0JBQW9CLEdBQVcsR0FBRyxDQUFBO0FBQ3RDLElBQUksYUFBYSxHQUFXLENBQUMsQ0FBQTtBQUM3QixJQUFJLFVBQVUsR0FBVyxDQUFDLFNBQVMsR0FBRyxTQUFTLENBQUMsR0FBRyxDQUFDLENBQUE7QUFDcEQsSUFBSSxpQkFBaUIsR0FBUSxJQUFJLENBQUE7QUFHakMsSUFBSSxRQUFRLEdBQWlCLEVBQUUsQ0FBQTtBQUUvQixJQUFJLENBQUM7SUFLSCxJQUFJLEVBQUUsRUFFTDtJQUtELE1BQU0sRUFBRSxVQUFVLE9BQVk7UUFDNUIsT0FBTyxDQUFDLEdBQUcsQ0FBQyxRQUFRLEVBQUUsT0FBTyxDQUFDLENBQUE7SUFDaEMsQ0FBQztJQUtELE9BQU8sRUFBRTtR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QUFFLENBQUMsR0FBRyxHQUFHLENBQUMsQ0FBQTtJQUM5QixDQUFDO0lBRUQsTUFBTTtRQUNKLFdBQVcsR0FBRyxFQUFFLENBQUE7UUFDaEIsYUFBYSxHQUFHLENBQUMsQ0FBQTtRQUNqQixVQUFVLEdBQUcsQ0FBQyxTQUFTLEdBQUcsU0FBUyxDQUFDLEdBQUcsQ0FBQyxDQUFBO1FBQ3hDLEdBQUcsQ0FBQyxTQUFTLEdBQUcsR0FBRyxDQUFDLEtBQUssQ0FBQTtJQUMzQixDQUFDO0lBRUQsTUFBTTtRQUNKLEdBQUcsQ0FBQyxTQUFTLEdBQUcsZUFBZSxDQUFDO1FBQ2hDLEdBQUcsQ0FBQyxTQUFTLENBQUMsRUFBRSxFQUFFLEVBQUUsRUFBRSxHQUFHLENBQUMsTUFBTSxDQUFDLEtBQUssR0FBRyxFQUFFLEVBQUUsR0FBRyxDQUFDLE1BQU0sQ0FBQyxNQUFNLEdBQUcsRUFBRSxDQUFDLENBQUE7UUFDcEUsR0FBRyxDQUFDLFFBQVEsQ0FBQyxFQUFFLEVBQUUsRUFBRSxFQUFFLEdBQUcsQ0FBQyxNQUFNLENBQUMsS0FBSyxHQUFHLEVBQUUsRUFBRSxHQUFHLENBQUMsTUFBTSxDQUFDLE1BQU0sR0FBRyxFQUFFLENBQUMsQ0FBQTtRQUNuRSxRQUFRLEdBQUcsRUFBRSxDQUFBO1FBQ2IsSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFBO1FBQ2IsUUFBUSxHQUFHLElBQUksQ0FBQTtRQUNmLE9BQU8sQ0FBQyxHQUFHLENBQUMsUUFBUSxDQUFDLENBQUE7UUFDckIsT0FBTyxDQUFDLEdBQUcsQ0FBQyxVQUFVLENBQUMsQ0FBQTtJQUN6QixDQUFDO0NBRUYsQ0FBQyxDQUFBIiwic291cmNlc0NvbnRlbnQiOlsiLy8gbWluaXByb2dyYW0vcGFnZXMvc2lnbmF0dXJlLmpzXG5pbXBvcnQgeyBCZXppZXIgfSBmcm9tICcuLi8uLi9saWIvYmV6aWVyJ1xuaW1wb3J0IHsgQmFzaWNQb2ludCwgUG9pbnQgfSBmcm9tICcuLi8uLi9saWIvcG9pbnQnXG5pbXBvcnQgeyB0aHJvdHRsZSB9IGZyb20gJy4uLy4uL2xpYi90aHJvdHRsZSdcblxuXG5leHBvcnQgaW50ZXJmYWNlIFBvaW50R3JvdXAge1xuICBjb2xvcjogc3RyaW5nO1xuICBwb2ludHM6IEJhc2ljUG9pbnRbXTtcbn1cblxuLy8gY2FudmFzIGNvbnRleHRcbmxldCBjdHg6IGFueSA9IG51bGxcbi8vIHRvdWNoIGRyYXdpbmdcbmxldCBpc1RvdWNoaW5nOiBib29sZWFuID0gZmFsc2VcbmxldCBfaXNFbXB0eTogYm9vbGVhbiA9IGZhbHNlXG5sZXQgbWluRGlzdGFuY2U6IG51bWJlciA9IDVcbmxldCBiYWNrZ3JvdW5kQ29sb3IgPSAnIzRmNzM2ZCdcbmxldCBwZW4gPSB7IGNvbG9yOiAnIzMzMzMzMycsIHdpZHRoOiAxLCBfbWF4V2lkdGg6IDEwIH1cbmxldCBkcHIgPSAxXG5cbmxldCBfbWF4V2lkdGg6IG51bWJlciA9IDIuNVxubGV0IF9taW5XaWR0aDogbnVtYmVyID0gMC41XG5sZXQgX2RvdFNpemU6IG51bWJlciA9IChfbWluV2lkdGggKyBfbWF4V2lkdGgpIC8gMlxuXG5sZXQgX2xhc3RQb2ludHM6IFBvaW50W10gPSBbXVxubGV0IHZlbG9jaXR5RmlsdGVyV2VpZ2h0OiBudW1iZXIgPSAwLjdcbmxldCBfbGFzdFZlbG9jaXR5OiBudW1iZXIgPSAwXG5sZXQgX2xhc3RXaWR0aDogbnVtYmVyID0gKF9taW5XaWR0aCArIF9tYXhXaWR0aCkgLyAyXG5sZXQgX3N0cm9rZU1vdmVVcGRhdGU6IGFueSA9IG51bGxcblxuLy8g5pe26Ze06L2077yM6K6w5b2V5pON5L2c5q2l6aqk5pWw5o2uXG5sZXQgdGltZUxpbmU6IFBvaW50R3JvdXBbXSA9IFtdXG5cblBhZ2Uoe1xuXG4gIC8qKlxuICAgKiBQYWdlIGluaXRpYWwgZGF0YVxuICAgKi9cbiAgZGF0YToge1xuXG4gIH0sXG5cbiAgLyoqXG4gICAqIExpZmVjeWNsZSBmdW5jdGlvbi0tQ2FsbGVkIHdoZW4gcGFnZSBsb2FkXG4gICAqL1xuICBvbkxvYWQ6IGZ1bmN0aW9uIChvcHRpb25zOiBhbnkpIHtcbiAgICBjb25zb2xlLmxvZygnb25Mb2FkJywgb3B0aW9ucylcbiAgfSxcblxuICAvKipcbiAgICogTGlmZWN5Y2xlIGZ1bmN0aW9uLS1DYWxsZWQgd2hlbiBwYWdlIGlzIGluaXRpYWxseSByZW5kZXJlZFxuICAgKi9cbiAgb25SZWFkeTogZnVuY3Rpb24gKCkge1xuICAgIHRoaXMuaW5pdENvbnRleHQoKVxuICAgIF9zdHJva2VNb3ZlVXBkYXRlID0gdGhyb3R0bGUodGhpcy5fc3Ryb2tlVXBkYXRlLCAxNilcbiAgfSxcblxuICAvKipcbiAgICogTGlmZWN5Y2xlIGZ1bmN0aW9uLS1DYWxsZWQgd2hlbiBwYWdlIHNob3dcbiAgICovXG4gIG9uU2hvdzogZnVuY3Rpb24gKCkge1xuXG4gIH0sXG5cbiAgLyoqXG4gICAqIExpZmVjeWNsZSBmdW5jdGlvbi0tQ2FsbGVkIHdoZW4gcGFnZSBoaWRlXG4gICAqL1xuICBvbkhpZGU6IGZ1bmN0aW9uICgpIHtcblxuICB9LFxuXG4gIC8qKlxuICAgKiBMaWZlY3ljbGUgZnVuY3Rpb24tLUNhbGxlZCB3aGVuIHBhZ2UgdW5sb2FkXG4gICAqL1xuICBvblVubG9hZDogZnVuY3Rpb24gKCkge1xuXG4gIH0sXG5cbiAgLyoqXG4gICAqIGluaXQgY2FudmFzIGNvbnRleHRcbiAgICovXG4gIGluaXRDb250ZXh0ICgpIHtcbiAgICBjb25zdCB7IHBpeGVsUmF0aW8sIHdpbmRvd1dpZHRoLCB3aW5kb3dIZWlnaHQgfSA9IHd4LmdldFN5c3RlbUluZm9TeW5jKClcbiAgICBkcHIgPSBwaXhlbFJhdGlvXG4gICAgY29uc29sZS5sb2coJ3BpeGVsUmF0aW8nLCBwaXhlbFJhdGlvKVxuXG4gICAgY29uc3QgcXVlcnkgPSB3eC5jcmVhdGVTZWxlY3RvclF1ZXJ5KClcbiAgICBxdWVyeS5zZWxlY3QoJyNjYW52YXMnKS5ub2RlKCkuZXhlYygocmVzOiBhbnlbXSkgPT4ge1xuICAgICAgY29uc3QgY2FudmFzID0gcmVzWzBdLm5vZGVcbiAgICAgIGNvbnNvbGUubG9nKCdjYW52YXMgLS0tICcsIGNhbnZhcylcbiAgICAgIC8vIGNhbnZhcy53aWR0aCA9IHdpbmRvd1dpZHRoICogZHByXG4gICAgICAvLyBjYW52YXMuaGVpZ2h0ID0gd2luZG93SGVpZ2h0ICogZHByXG4gICAgICBjYW52YXMud2lkdGggPSB3aW5kb3dXaWR0aFxuICAgICAgY2FudmFzLmhlaWdodCA9IHdpbmRvd0hlaWdodFxuXG4gICAgICBjdHggPSBjYW52YXMuZ2V0Q29udGV4dCgnMmQnKVxuICAgICAgLy8gY3R4LnNjYWxlKHBpeGVsUmF0aW8sIHBpeGVsUmF0aW8pXG4gICAgICBjb25zb2xlLmxvZygnY3R4JywgY3R4KVxuXG4gICAgICBjdHguZmlsbFN0eWxlID0gYmFja2dyb3VuZENvbG9yXG4gICAgICBjdHguZmlsbFJlY3QoMTYsIDE2LCBjdHguY2FudmFzLndpZHRoIC0gMzIsIGN0eC5jYW52YXMuaGVpZ2h0IC0gMzIpXG4gICAgfSlcbiAgfSxcblxuICBvblRvdWNoU3RhcnQgKGV2ZW50OiBhbnkpIDogdm9pZCB7XG4gICAgY29uc29sZS5sb2coJ3RvdWNoIHN0YXJ0IC0tICcsIGV2ZW50KVxuICAgIGlzVG91Y2hpbmcgPSB0cnVlXG4gICAgdGhpcy5fc3Ryb2tlQmVnaW4oZXZlbnQpXG4gIH0sXG5cbiAgb25Ub3VjaE1vdmUgKGV2ZW50OiBhbnkpIDogdm9pZCB7XG4gICAgLy8gY29uc29sZS5sb2coJ3RvdWNoIG1vdmUgLS0nLCBldmVudClcbiAgICBfc3Ryb2tlTW92ZVVwZGF0ZShldmVudClcbiAgfSxcblxuICBvblRvdWNoRW5kIChldmVudDogYW55KSA6IHZvaWQge1xuICAgIGNvbnNvbGUubG9nKCd0b3VjaCBlbmQgLS0nLCBldmVudClcbiAgICBpc1RvdWNoaW5nID0gZmFsc2VcbiAgICB0aGlzLl9zdHJva2VFbmQoZXZlbnQpXG4gIH0sXG5cbiAgb25Ub3VjaENhbmNlbCAoZXZlbnQ6IGFueSkgOiB2b2lkIHtcbiAgICBjb25zb2xlLmxvZygndG91Y2ggY2FuY2VsJywgZXZlbnQpXG4gICAgaXNUb3VjaGluZyA9IGZhbHNlXG4gICAgdGhpcy5fc3Ryb2tlRW5kKGV2ZW50KVxuICB9LFxuXG4gIG9uRXJyb3IgKGV2ZW50OiBhbnkpIHtcbiAgICBjb25zb2xlLmxvZygnY2FudmFzIGVycm9yJywgZXZlbnQpXG4gICAgaXNUb3VjaGluZyA9IGZhbHNlXG4gICAgdGhpcy5fc3Ryb2tlRW5kKGV2ZW50KVxuICB9LFxuXG4gIF9zdHJva2VCZWdpbiAoZXZlbnQ/OiBhbnkpIDogdm9pZCB7XG4gICAgY29uc29sZS5sb2coJ19zdHJva2VCZWdpbiArKysrKysrKycpXG4gICAgY29uc3QgbmV3UG9pbnRHcm91cCA9IHtcbiAgICAgIGNvbG9yOiBwZW4uY29sb3IsXG4gICAgICBwb2ludHM6IFtdLFxuICAgIH07XG4gICAgdGltZUxpbmUucHVzaChuZXdQb2ludEdyb3VwKTtcbiAgICB0aGlzLl9yZXNldCgpO1xuICAgIF9zdHJva2VNb3ZlVXBkYXRlKGV2ZW50KVxuICB9LFxuXG4gIF9zdHJva2VVcGRhdGUgKGV2ZW50OiBhbnkpIDogdm9pZCB7XG4gICAgaWYgKHRpbWVMaW5lLmxlbmd0aCA9PT0gMCkge1xuICAgICAgdGhpcy5fc3Ryb2tlQmVnaW4oZXZlbnQpXG4gICAgICByZXR1cm5cbiAgICB9XG4gICAgY29uc3Qge3gsIHl9ID0gZXZlbnQuY2hhbmdlZFRvdWNoZXNbMF1cbiAgICBjb25zdCBwb2ludCA9IHRoaXMuX2NyZWF0ZVBvaW50KHgsIHkpXG4gICAgY29uc3QgbGFzdFBvaW50R3JvdXAgPSB0aW1lTGluZVt0aW1lTGluZS5sZW5ndGggLSAxXVxuICAgIGNvbnN0IGxhc3RQb2ludHMgPSBsYXN0UG9pbnRHcm91cC5wb2ludHNcbiAgICBjb25zdCBsYXN0UG9pbnQgPSBsYXN0UG9pbnRzLmxlbmd0aCA+IDAgJiYgbGFzdFBvaW50c1tsYXN0UG9pbnRzLmxlbmd0aCAtIDFdXG4gICAgY29uc3QgaXNMYXN0UG9pbnRUb29DbG9zZSA9IGxhc3RQb2ludCA/IHBvaW50LmRpc3RhbmNlVG8obGFzdFBvaW50KSA8PSBtaW5EaXN0YW5jZSA6IGZhbHNlXG4gICAgcGVuLmNvbG9yID0gbGFzdFBvaW50R3JvdXAuY29sb3JcbiAgICBpZiAoIWxhc3RQb2ludCB8fCAhKGxhc3RQb2ludCAmJiBpc0xhc3RQb2ludFRvb0Nsb3NlKSkge1xuICAgICAgY29uc3QgY3VydmUgPSB0aGlzLl9hZGRQb2ludChwb2ludClcbiAgICAgIGlmICghbGFzdFBvaW50cykge1xuICAgICAgICB0aGlzLl9kcmF3RG90KHBvaW50KVxuICAgICAgfSBlbHNlIGlmIChjdXJ2ZSkge1xuICAgICAgICB0aGlzLl9kcmF3Q3VydmUoY3VydmUpXG4gICAgICB9XG4gICAgfVxuICB9LFxuXG4gIF9zdHJva2VFbmQgKGV2ZW50OiBhbnkpIDogdm9pZCB7XG4gICAgY29uc29sZS5sb2coJ2VuZCArKysrKysrICcsIGV2ZW50KVxuICAgIF9zdHJva2VNb3ZlVXBkYXRlKGV2ZW50KVxuICB9LFxuXG4gIF9jYWxjdWxhdGVDdXJ2ZVdpZHRocyAoc3RhcnRQb2ludDogUG9pbnQsIGVuZFBvaW50OiBQb2ludCkgOiB7IHN0YXJ0OiBudW1iZXI7IGVuZDogbnVtYmVyIH0ge1xuICAgIGNvbnN0IHZlbG9jaXR5ID0gdmVsb2NpdHlGaWx0ZXJXZWlnaHQgKiBlbmRQb2ludC52ZWxvY2l0eUZyb20oc3RhcnRQb2ludCkgKyAoMSAtIHZlbG9jaXR5RmlsdGVyV2VpZ2h0KSAqIF9sYXN0VmVsb2NpdHlcbiAgICBjb25zdCBuZXdXaWR0aCA9IHRoaXMuX3N0cm9rZVdpZHRoKHZlbG9jaXR5KVxuICAgIGNvbnN0IHdpZHRocyA9IHtcbiAgICAgIHN0YXJ0OiBfbGFzdFdpZHRoLFxuICAgICAgZW5kOiBuZXdXaWR0aCxcbiAgICB9XG4gICAgX2xhc3RWZWxvY2l0eSA9IHZlbG9jaXR5XG4gICAgX2xhc3RXaWR0aCA9IG5ld1dpZHRoXG4gICAgcmV0dXJuIHdpZHRoc1xuICB9LFxuXG4gIF9zdHJva2VXaWR0aCAodmVsb2NpdHk6IG51bWJlcikge1xuICAgIHJldHVybiBNYXRoLm1heChfbWF4V2lkdGggLyAodmVsb2NpdHkgKyAxKSwgX21pbldpZHRoKTtcbiAgfSxcblxuICBfY3JlYXRlUG9pbnQoeDogbnVtYmVyLCB5OiBudW1iZXIpOiBQb2ludCB7XG4gICAgLy8gY29uc3Qge2xlZnQsIHRvcH0gPSBjdHguY2FudmFzO1xuICAgIGNvbnN0IGxlZnQgPSAwO1xuICAgIGNvbnN0IHRvcCA9IDA7XG4gICAgcmV0dXJuIG5ldyBQb2ludCh4IC0gbGVmdCwgeSAtIHRvcCwgbmV3IERhdGUoKS5nZXRUaW1lKCkpO1xuICB9LFxuXG4gIF9hZGRQb2ludChwb2ludDogUG9pbnQpIDogQmV6aWVyIHwgbnVsbCB7XG4gICAgaWYgKHRpbWVMaW5lLmxlbmd0aCA+IDEpIHtcbiAgICAgIGNvbnNvbGUubG9nKCctLS0tLS0tLS0tIHRpbWVMaW5lIC0tLS0tLScpXG4gICAgICB0aW1lTGluZVt0aW1lTGluZS5sZW5ndGggLSAxXS5wb2ludHMucHVzaChwb2ludClcbiAgICB9XG4gICAgX2xhc3RQb2ludHMucHVzaChwb2ludCk7XG4gICAgaWYgKF9sYXN0UG9pbnRzLmxlbmd0aCA+IDIpIHtcbiAgICAgIC8vIFRvIHJlZHVjZSB0aGUgaW5pdGlhbCBsYWcgbWFrZSBpdCB3b3JrIHdpdGggMyBwb2ludHNcbiAgICAgIC8vIGJ5IGNvcHlpbmcgdGhlIGZpcnN0IHBvaW50IHRvIHRoZSBiZWdpbm5pbmcuXG4gICAgICBpZiAoX2xhc3RQb2ludHMubGVuZ3RoID09PSAzKSB7XG4gICAgICAgIF9sYXN0UG9pbnRzLnVuc2hpZnQoX2xhc3RQb2ludHNbMF0pO1xuICAgICAgfVxuXG4gICAgICAvLyBfcG9pbnRzIGFycmF5IHdpbGwgYWx3YXlzIGhhdmUgNCBwb2ludHMgaGVyZS5cbiAgICAgIGNvbnN0IHdpZHRocyA9IHRoaXMuX2NhbGN1bGF0ZUN1cnZlV2lkdGhzKF9sYXN0UG9pbnRzWzFdLCBfbGFzdFBvaW50c1syXSk7XG4gICAgICBjb25zdCBjdXJ2ZSA9IEJlemllci5mcm9tUG9pbnRzKF9sYXN0UG9pbnRzLCB3aWR0aHMpO1xuXG4gICAgICAvLyBSZW1vdmUgdGhlIGZpcnN0IGVsZW1lbnQgZnJvbSB0aGUgbGlzdCwgc28gdGhhdCB0aGVyZSBhcmUgbm8gbW9yZSB0aGFuIDQgcG9pbnRzIGF0IGFueSB0aW1lLlxuICAgICAgX2xhc3RQb2ludHMuc2hpZnQoKTtcblxuICAgICAgcmV0dXJuIGN1cnZlO1xuICAgIH1cblxuICAgIHJldHVybiBudWxsO1xuICB9LFxuXG4gIF9kcmF3RG90IChwb2ludDogQmFzaWNQb2ludCkgOiB2b2lkIHtcbiAgICBjdHguYmVnaW5QYXRoKCk7XG4gICAgY29uc3Qgd2lkdGggPSBfZG90U2l6ZVxuICAgIHRoaXMuX2RyYXdDdXJ2ZVNlZ21lbnQocG9pbnQueCwgcG9pbnQueSwgd2lkdGgpO1xuICAgIGN0eC5jbG9zZVBhdGgoKTtcbiAgICBjdHguZmlsbFN0eWxlID0gcGVuLmNvbG9yO1xuICAgIGN0eC5maWxsKCk7XG4gIH0sXG5cbiAgX2RyYXdDdXJ2ZVNlZ21lbnQgKHg6IG51bWJlciwgeTpudW1iZXIsIHdpZHRoOiBudW1iZXIpIHtcbiAgICBjdHgubW92ZVRvKHgsIHkpXG4gICAgY3R4LmFyYyh4LCB5LCB3aWR0aCwgMCwgMiAqIE1hdGguUEksIGZhbHNlKVxuICAgIF9pc0VtcHR5ID0gZmFsc2VcbiAgfSxcblxuICBfZHJhd0N1cnZlKGN1cnZlOiBCZXppZXIpOiB2b2lkIHtcbiAgICBjb25zb2xlLmxvZygnX2RyYXdDdXJ2ZSAtLS0tICcsIGN1cnZlKVxuICAgIGNvbnN0IHdpZHRoRGVsdGEgPSBjdXJ2ZS5lbmRXaWR0aCAtIGN1cnZlLnN0YXJ0V2lkdGhcbiAgICAvLyAnMicgaXMganVzdCBhbiBhcmJpdHJhcnkgbnVtYmVyIGhlcmUuIElmIG9ubHkgbGVuZ2h0IGlzIHVzZWQsIHRoZW5cbiAgICAvLyB0aGVyZSBhcmUgZ2FwcyBiZXR3ZWVuIGN1cnZlIHNlZ21lbnRzIDovXG4gICAgY29uc3QgZHJhd1N0ZXBzID0gTWF0aC5mbG9vcihjdXJ2ZS5sZW5ndGgoKSkgKiAyXG5cbiAgICBjdHguYmVnaW5QYXRoKClcbiAgICBjdHguZmlsbFN0eWxlID0gcGVuLmNvbG9yXG5cbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGRyYXdTdGVwczsgaSArPSAxKSB7XG4gICAgICAvLyBDYWxjdWxhdGUgdGhlIEJlemllciAoeCwgeSkgY29vcmRpbmF0ZSBmb3IgdGhpcyBzdGVwLlxuICAgICAgY29uc3QgdCA9IGkgLyBkcmF3U3RlcHNcbiAgICAgIGNvbnN0IHR0ID0gdCAqIHRcbiAgICAgIGNvbnN0IHR0dCA9IHR0ICogdFxuICAgICAgY29uc3QgdSA9IDEgLSB0XG4gICAgICBjb25zdCB1dSA9IHUgKiB1XG4gICAgICBjb25zdCB1dXUgPSB1dSAqIHVcblxuICAgICAgbGV0IHggPSB1dXUgKiBjdXJ2ZS5zdGFydFBvaW50LnhcbiAgICAgIHggKz0gMyAqIHV1ICogdCAqIGN1cnZlLmNvbnRyb2wxLnhcbiAgICAgIHggKz0gMyAqIHUgKiB0dCAqIGN1cnZlLmNvbnRyb2wyLnhcbiAgICAgIHggKz0gdHR0ICogY3VydmUuZW5kUG9pbnQueFxuXG4gICAgICBsZXQgeSA9IHV1dSAqIGN1cnZlLnN0YXJ0UG9pbnQueVxuICAgICAgeSArPSAzICogdXUgKiB0ICogY3VydmUuY29udHJvbDEueVxuICAgICAgeSArPSAzICogdSAqIHR0ICogY3VydmUuY29udHJvbDIueVxuICAgICAgeSArPSB0dHQgKiBjdXJ2ZS5lbmRQb2ludC55XG5cbiAgICAgIGNvbnN0IHdpZHRoID0gTWF0aC5taW4oXG4gICAgICAgIGN1cnZlLnN0YXJ0V2lkdGggKyB0dHQgKiB3aWR0aERlbHRhLFxuICAgICAgICBwZW4uX21heFdpZHRoLFxuICAgICAgKTtcbiAgICAgIHRoaXMuX2RyYXdDdXJ2ZVNlZ21lbnQoeCwgeSwgd2lkdGgpO1xuICAgIH1cblxuICAgIGN0eC5jbG9zZVBhdGgoKTtcbiAgICBjdHguZmlsbCgpO1xuICB9LFxuXG4gIF9saW5lVG8gKHg6IG51bWJlciwgeTogbnVtYmVyKSA6IHZvaWQge1xuICAgIGN0eC5saW5lVG8oeCAqIGRwciwgeSAqIGRwcilcbiAgfSxcblxuICBfbW92ZVRvICh4OiBudW1iZXIsIHk6IG51bWJlcikgOiB2b2lkIHtcbiAgICBjdHgubW92ZVRvKHggKiBkcHIsIHkgKiBkcHIpXG4gIH0sXG5cbiAgX3Jlc2V0ICgpIDogdm9pZCB7XG4gICAgX2xhc3RQb2ludHMgPSBbXVxuICAgIF9sYXN0VmVsb2NpdHkgPSAwXG4gICAgX2xhc3RXaWR0aCA9IChfbWluV2lkdGggKyBfbWF4V2lkdGgpIC8gMlxuICAgIGN0eC5maWxsU3R5bGUgPSBwZW4uY29sb3JcbiAgfSxcblxuICBfY2xlYXIgKCkgOiB2b2lkIHtcbiAgICBjdHguZmlsbFN0eWxlID0gYmFja2dyb3VuZENvbG9yO1xuICAgIGN0eC5jbGVhclJlY3QoMTYsIDE2LCBjdHguY2FudmFzLndpZHRoIC0gMzIsIGN0eC5jYW52YXMuaGVpZ2h0IC0gMzIpXG4gICAgY3R4LmZpbGxSZWN0KDE2LCAxNiwgY3R4LmNhbnZhcy53aWR0aCAtIDMyLCBjdHguY2FudmFzLmhlaWdodCAtIDMyKVxuICAgIHRpbWVMaW5lID0gW11cbiAgICB0aGlzLl9yZXNldCgpXG4gICAgX2lzRW1wdHkgPSB0cnVlXG4gICAgY29uc29sZS5sb2coX2lzRW1wdHkpXG4gICAgY29uc29sZS5sb2coaXNUb3VjaGluZylcbiAgfSxcblxufSkiXX0=